{
    "AWSTemplateFormatVersion" : "2010-09-09",

    "Description" : "Patrick EC2 stack for running my services.",

    "Parameters" : {
        "KeyName": {
            "Description": "SSH Keypair to use for the EC2 Instance.",
            "Type": "AWS::EC2::KeyPair::KeyName"
        }
    },
    "Mappings" : {},
    "Conditions" : {},
    "Resources" : {
        "securitygroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "GroupDescription" : "Security group for test",
                "SecurityGroupEgress" : [],
                "SecurityGroupIngress" : [
                    {
                       "CidrIp": "0.0.0.0/0",
                       "FromPort" : "443",
                       "IpProtocol" : "tcp",
                       "ToPort" : "443"
                    },
                    {
                       "CidrIp": "0.0.0.0/0",
                       "FromPort" : "22",
                       "IpProtocol" : "tcp",
                       "ToPort" : "22"
                    },
                    {
                       "CidrIp": "0.0.0.0/0",
                       "FromPort" : "80",
                       "IpProtocol" : "tcp",
                       "ToPort" : "80"
                    }
                ],
                "VpcId" : "vpc-860ba5e1"
             }
        },
        "nodemusicec2instance" : {
            "Type" : "AWS::EC2::Instance",
            "Metadata" : {
                "AWS::CloudFormation::Init" : {
                    "config" : {
                        "packages" : {
                            "apt" : {
                                "git" : [],
                                "nginx" : []
                            }
                        },
                        "services" : {
                            "sysvinit" : {
                                "nginx" : {
                                    "enabled" : "true",
                                    "ensureRunning" : "true",
                                    "files" : [ "/etc/nginx/sites-available/nodemusic.net",
                                                "/etc/nginx/sites-available/simplysortedsoftware.com"]
                                }
                            }
                        },
                        "files" : {
                            "/home/ubuntu/nodemsuic.net" : {
                                "content" : { "Fn::Join" : ["", [
                                    "server {",
                                    "   listen 80;",
                                    "   server_name nodemusic.net;",
                                    "   location / {",
                                    "       proxy_pass http://localhost:80;",
                                    "       proxy_set_header Host $host;",
                                    "       proxy_set_header X-Real-IP $remote_addr;",
                                    "        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;",
                                    "        proxy_set_header X-Forwarded-Proto $scheme;",
                                    "   }",
                                    "}"
                                ]] },
                                "owner" : "ubuntu",
                                "encoding" : "plain",
                                "mode" : "000644"
                            }
                        }
                    }
                }
            },
            "Properties" : {
                "SecurityGroupIds" : [ 
                    { 
                        "Fn::GetAtt" : ["securitygroup", "GroupId"]
                    } 
                ],
                "SubnetId" : "subnet-3d184c17",
                "AvailabilityZone" : "us-east-1d",
                "KeyName" : {
                    "Ref" : "KeyName"
                },
                "ImageId" : "ami-fce3c696",
                "InstanceType" : "t2.micro",
                "UserData": {
                    "Fn::Base64": { "Fn::Join" : ["", [
                        "#!/bin/bash\n",
                        "sudo apt-get -y install python-setuptools\n",
                        "sudo easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\n",
                        "/opt/aws/bin/cfn-init",
                        "sudo cp /home/ubuntu/nodemusic.net /etc/nginx/sites-available/nodemusic.net",
                        "sudo cp /home/ubuntu/simplysortedsoftware.com > /etc/nginx/sites-available/simplysortedsoftware.com",
                        "sudo rm /etc/nginx/sites-enabled/default",
                        "sudo ln -s /etc/nginx/sites-available/nodemusic.net /etc/nginx/sites-enabled/",
                        "sudo ln -s /etc/nginx/sites-available/simplysortedsoftware.com /etc/nginx/sites-enabled/",
                        "sudo service nginx reload",
                        "",
                        "sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10",
                        "echo 'deb http://repo.mongodb.org/apt/ubuntu '$(lsb_release -sc)'/mongodb-org/3.0 multiverse' | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list",
                        "sudo apt-get update",
                        "sudo apt-get install -y mongodb-org"
                        ]]
                    }
                }
            }
        }
    }
}